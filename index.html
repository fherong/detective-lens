<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WayneTech Detective Mode (MediaPipe)</title>

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="WayneTech">
    <link rel="apple-touch-icon" href="icon.png">

    <style>
        body { margin: 0; background-color: #000; overflow: hidden; font-family: 'Courier New', Courier, monospace; }
        
        #cam-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        .mirrored { transform: scaleX(-1); }

        #video { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: 1; }
        #canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 2; }

        #hud { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 3; pointer-events: none; }
        .hud-header { position: absolute; top: 40px; left: 20px; color: #00f7ff; text-shadow: 0 0 5px #00f7ff; }
        
        #flip-btn {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            border: 1px solid #00f7ff; background: rgba(0, 0, 0, 0.5); color: #00f7ff;
            padding: 10px 20px; font-family: 'Courier New', Courier, monospace; font-weight: bold;
            cursor: pointer; pointer-events: auto; z-index: 10;
        }

        .loading { 
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); 
            color: #00f7ff; font-size: 16px; z-index: 4; text-align: center; text-shadow: 0 0 10px #00f7ff;
        }
        
        .scanline {
            width: 100%; height: 5px; background: rgba(0, 247, 255, 0.3);
            position: absolute; z-index: 3; animation: scan 2.5s linear infinite; top: 0;
            pointer-events: none;
        }
        @keyframes scan { 0% { top: 0%; opacity: 0; } 10% { opacity: 1; } 90% { opacity: 1; } 100% { top: 100%; opacity: 0; } }
        
        .vignette {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle, transparent 60%, black 100%);
            z-index: 3; pointer-events: none;
        }
    </style>
    
    <script type="module">
        import {
            ObjectDetector,
            FilesetResolver
        } from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.2";

        let objectDetector;
        let runningMode = "VIDEO";
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const status = document.getElementById('status');
        const flipBtn = document.getElementById('flip-btn');
        const container = document.getElementById('cam-container');
        let lastVideoTime = -1;

        // --- INIT MEDIAPIPE ---
        const initializeObjectDetector = async () => {
            status.innerHTML = "LOADING SYSTEMS...<br><span style='font-size:10px'>DOWNLOADING WASM KERNELS</span>";
            
            const vision = await FilesetResolver.forVisionTasks(
                "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.2/wasm"
            );
            
            objectDetector = await ObjectDetector.createFromOptions(vision, {
                baseOptions: {
                    modelAssetPath: "https://storage.googleapis.com/mediapipe-models/object_detector/efficientdet_lite0/float16/1/efficientdet_lite0.tflite",
                    delegate: "GPU" // FORCE GPU ACCELERATION
                },
                scoreThreshold: 0.5, // 50% Confidence required
                runningMode: runningMode
            });
            
            status.style.display = "none";
            setupCamera();
        };

        // --- CAMERA SETUP ---
        async function setupCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { 
                        facingMode: "environment",
                        width: { ideal: 1920 },
                        height: { ideal: 1080 } 
                    }
                });
                video.srcObject = stream;
                video.addEventListener("loadeddata", predictWebcam);
            } catch (err) {
                status.style.display = "block";
                status.innerText = "CAMERA ERROR";
            }
        }

        // --- DETECTION LOOP ---
        async function predictWebcam() {
            let startTimeMs = performance.now();

            if (video.currentTime !== lastVideoTime) {
                lastVideoTime = video.currentTime;
                
                // DETECT
                const detections = objectDetector.detectForVideo(video, startTimeMs).detections;
                
                // DRAW
                drawResults(detections);
            }
            window.requestAnimationFrame(predictWebcam);
        }

        function drawResults(detections) {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            for (const detection of detections) {
                // Get Label & Score
                const score = Math.round(detection.categories[0].score * 100);
                let rawLabel = detection.categories[0].categoryName.toUpperCase();
                const box = detection.boundingBox;

                // --- BATMAN LOGIC START ---
                let category = "OBJECT";
                let color = "#00f7ff"; // Cyan

                // Patches for dumb AI
                if (rawLabel === "TV") rawLabel = "DISPLAY SCREEN";
                if (rawLabel === "MOUSE") rawLabel = "CONTROLLER";
                if (rawLabel === "TOILET") continue; // Skip

                // Categorization
                const animals = ["BIRD", "CAT", "DOG", "HORSE", "SHEEP", "COW", "ELEPHANT", "BEAR", "ZEBRA", "GIRAFFE"];
                const vehicles = ["BICYCLE", "CAR", "MOTORCYCLE", "AIRPLANE", "BUS", "TRAIN", "TRUCK", "BOAT"];
                const weapons = ["KNIFE", "SCISSORS", "BASEBALL BAT"];

                if (rawLabel === "PERSON") { category = "HUMAN"; color = "#ff3333"; }
                else if (animals.includes(rawLabel)) { category = "ANIMAL"; color = "#00ff00"; }
                else if (vehicles.includes(rawLabel)) { category = "VEHICLE"; }
                else if (weapons.includes(rawLabel)) { category = "WEAPON"; color = "#ff3333"; }
                else if (rawLabel === "CELL PHONE" || rawLabel === "LAPTOP" || rawLabel === "DISPLAY SCREEN") { category = "TECH"; color = "#eebb00"; }

                let displayLabel = category + ": " + rawLabel;

                // Drawing
                ctx.strokeStyle = color;
                ctx.lineWidth = 3;
                ctx.shadowBlur = 10;
                ctx.shadowColor = color;
                ctx.strokeRect(box.originX, box.originY, box.width, box.height);

                // Text Background
                const textWidth = ctx.measureText(displayLabel).width;
                ctx.fillStyle = color === "#ff3333" ? "rgba(255, 0, 0, 0.3)" : "rgba(0, 247, 255, 0.2)";
                ctx.fillRect(box.originX, box.originY - 25, textWidth + 60, 25);

                // Text
                ctx.fillStyle = color;
                ctx.font = "bold 16px 'Courier New'";
                ctx.fillText(displayLabel + " [" + score + "%]", box.originX + 5, box.originY - 7);
            }
        }

        // Global functions for HTML buttons
        window.toggleFlip = function() {
            container.classList.toggle('mirrored');
        }

        // START
        initializeObjectDetector();
    </script>
</head>
<body>
    <div class="loading" id="status">INITIALIZING SYSTEMS...</div>
    <div class="scanline"></div>
    <div class="vignette"></div>
    
    <div id="hud">
        <div class="hud-header">
            <h3>WAYNETECH // DETECTIVE MODE</h3>
            <small>SYSTEM: EFFICIENTDET-LITE | GPU: ACTIVE</small>
        </div>
        <button id="flip-btn" onclick="toggleFlip()">[ FLIP OPTICS ]</button>
    </div>

    <div id="cam-container">
        <video id="video" playsinline muted autoplay></video>
        <canvas id="canvas"></canvas>
    </div>
</body>
</html>
