<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WayneTech OS v9</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#000000">
    <link rel="apple-touch-icon" href="icon.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { wayne: '#00f7ff', alert: '#ff3333', panel: '#0a0a0a' },
                    fontFamily: { mono: ['Courier New', 'monospace'] },
                    animation: { 'spin-slow': 'spin 4s linear infinite' }
                }
            }
        }
    </script>

    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>
    <script src='https://unpkg.com/tesseract.js@v2.1.0/dist/tesseract.min.js'></script>

    <style>
        body { background-color: black; color: #00f7ff; overflow: hidden; touch-action: none; }
        
        .scanline {
            width: 100%; height: 100%; position: fixed; left: 0; top: 0; pointer-events: none; z-index: 50;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            background-size: 100% 2px, 3px 100%;
        }

        /* Loading Spinner */
        .loader {
            border: 4px solid rgba(0, 247, 255, 0.1); border-left-color: #00f7ff;
            border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="font-mono h-screen w-screen flex flex-col">

    <div class="scanline"></div>

    <header class="h-14 flex items-center justify-between px-4 border-b-2 border-wayne bg-black/90 z-40 backdrop-blur-md">
        <div class="text-xl font-bold tracking-widest text-wayne drop-shadow-[0_0_8px_rgba(0,247,255,0.8)]">WAYNETECH</div>
        <div id="clock" class="text-xs text-wayne/70">00:00</div>
    </header>

    <main id="viewport" class="flex-1 relative bg-black overflow-hidden">
        
        <div id="home" class="screen w-full h-full p-4 grid grid-cols-2 gap-4 overflow-y-auto pb-20 content-start">
            <button onclick="launch('detective')" class="dash-btn"><span>üëÅÔ∏è</span> DETECTIVE</button>
            <button onclick="launch('translator')" class="dash-btn"><span>üåê</span> TRANSLATOR</button>
            <button onclick="launch('nightvis')" class="dash-btn"><span>üåë</span> NIGHT VIS</button>
            <button onclick="launch('sonar')" class="dash-btn"><span>üì°</span> SONAR</button>
            <button onclick="launch('flash')" class="dash-btn border-red-500/50 bg-red-900/10 text-red-500"><span>üí£</span> FLASHBANG</button>
            
            <button onclick="launch('logs')" class="dash-btn opacity-70"><span>üìù</span> LOGS</button>
            <button onclick="launch('units')" class="dash-btn opacity-70"><span>üìê</span> UNITS</button>
            <button onclick="launch('chrono')" class="dash-btn opacity-70"><span>‚è±Ô∏è</span> CHRONO</button>
            <button onclick="launch('rng')" class="dash-btn opacity-70"><span>üé≤</span> RNG</button>
            <button onclick="launch('tally')" class="dash-btn opacity-70"><span>üî¢</span> TALLY</button>
        </div>

        <div id="app-detective" class="screen hidden w-full h-full relative">
            <video id="det-vid" class="absolute inset-0 w-full h-full object-cover" autoplay playsinline muted></video>
            <canvas id="det-can" class="absolute inset-0 w-full h-full object-cover z-10"></canvas>
            <div id="det-load" class="absolute inset-0 flex items-center justify-center bg-black/80 z-20">
                <div class="text-wayne text-center animate-pulse">INITIALIZING NEURAL NET...</div>
            </div>
            <div class="absolute bottom-5 left-0 w-full px-4 z-20">
                <div class="bg-black/60 backdrop-blur border border-wayne p-2 rounded">
                    <div class="flex justify-between text-xs mb-1"><span>CONFIDENCE</span> <span id="det-val">65%</span></div>
                    <input type="range" min="30" max="90" value="65" oninput="updateThresh(this.value)" class="w-full h-2 bg-gray-700 rounded-lg cursor-pointer">
                </div>
            </div>
        </div>

        <div id="app-translator" class="screen hidden w-full h-full flex flex-col">
            <div class="flex border-b border-wayne bg-black">
                <button onclick="transTab('text')" class="flex-1 p-4 bg-wayne/10 text-xs font-bold active:bg-wayne active:text-black border-r border-wayne">üí¨ COMM-LINK</button>
                <button onclick="transTab('cam')" class="flex-1 p-4 bg-wayne/10 text-xs font-bold active:bg-wayne active:text-black">üì∑ VISUAL INTEL</button>
            </div>

            <div id="trans-tab-text" class="flex-1 flex flex-col p-4 space-y-4 overflow-y-auto">
                <div class="relative">
                    <textarea id="trans-input" class="w-full h-32 bg-gray-900/50 border border-wayne p-4 text-sm rounded focus:outline-none text-white" placeholder="Enter text or tap mic..."></textarea>
                    <button onclick="startListening()" class="absolute bottom-2 right-2 p-3 bg-wayne text-black rounded-full shadow-[0_0_10px_#00f7ff] active:scale-90 transition">
                        üé§
                    </button>
                </div>

                <div class="flex items-center gap-2">
                    <span class="text-xs">TARGET:</span>
                    <select id="trans-lang" class="bg-black border border-wayne p-2 text-sm flex-1 rounded text-wayne">
                        <option value="es-ES">SPANISH</option>
                        <option value="fr-FR">FRENCH</option>
                        <option value="ja-JP">JAPANESE</option>
                        <option value="de-DE">GERMAN</option>
                        <option value="ru-RU">RUSSIAN</option>
                        <option value="zh-CN">CHINESE</option>
                    </select>
                </div>

                <button onclick="runTranslation()" class="w-full py-4 bg-wayne/20 border border-wayne font-bold tracking-widest hover:bg-wayne hover:text-black transition">
                    TRANSLATE & TRANSMIT
                </button>

                <div class="flex-1 bg-black border border-wayne/50 rounded p-4 relative min-h-[100px]">
                    <div class="text-xs text-wayne/50 mb-2">OUTPUT STREAM</div>
                    <div id="trans-output" class="text-lg text-white font-bold">Waiting for input...</div>
                </div>
            </div>

            <div id="trans-tab-cam" class="hidden flex-1 relative flex flex-col bg-black">
                <div class="relative flex-1 overflow-hidden">
                    <video id="trans-vid" class="absolute inset-0 w-full h-full object-cover" autoplay playsinline muted></video>
                    <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-64 h-20 border-2 border-wayne shadow-[0_0_20px_#00f7ff] z-10 box-border bg-wayne/5"></div>
                    <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 -mt-14 text-[10px] bg-black px-2 border border-wayne">ALIGN TEXT</div>
                </div>
                
                <div class="h-auto bg-gray-900 border-t border-wayne p-4">
                    <div class="flex justify-between items-center mb-2">
                        <div id="ocr-status" class="text-xs text-wayne animate-pulse">SYSTEM READY</div>
                        <select id="ocr-lang" class="bg-black border border-wayne text-xs p-1">
                            <option value="es-ES">TO SPANISH</option>
                            <option value="fr-FR">TO FRENCH</option>
                            <option value="ja-JP">TO JAPANESE</option>
                        </select>
                    </div>
                    <button onclick="captureOCR()" class="w-full py-3 bg-wayne text-black font-bold tracking-widest shadow-[0_0_15px_#00f7ff]">SCAN & TRANSLATE</button>
                    <div id="ocr-result" class="mt-2 text-xs text-white truncate h-5"></div>
                </div>
            </div>
        </div>

        <div id="app-nightvis" class="screen hidden w-full h-full relative">
            <canvas id="nv-can" class="w-full h-full object-cover"></canvas>
            <video id="nv-vid" class="hidden" autoplay playsinline muted></video>
            <div class="absolute bottom-10 w-full text-center"><span class="bg-black/50 px-4 py-1 border border-wayne rounded text-xs">DIGITAL GAIN ACTIVE</span></div>
        </div>

        <div id="app-sonar" class="screen hidden w-full h-full relative flex items-center justify-center bg-black overflow-hidden">
            <canvas id="sonar-can" class="relative z-10 rounded-full" width="300" height="300"></canvas>
            <div class="absolute w-[300px] h-[300px] rounded-full border border-wayne/30 pointer-events-none"></div>
            <div class="absolute w-[200px] h-[200px] rounded-full border border-wayne/30 pointer-events-none"></div>
            <div class="absolute w-[100px] h-[100px] rounded-full border border-wayne/30 pointer-events-none"></div>
            <div class="absolute inset-0 bg-[conic-gradient(from_0deg,transparent_0deg,rgba(0,247,255,0.2)_360deg)] w-[300px] h-[300px] rounded-full animate-spin m-auto pointer-events-none z-0"></div>
            <div class="absolute bottom-5 text-xs text-wayne bg-black/50 px-2 border border-wayne">360¬∞ ACOUSTIC ARRAY</div>
        </div>

        <div id="app-flash" class="screen hidden w-full h-full bg-white z-50 flex justify-center items-center cursor-pointer" onclick="toggleStrobe()">
            <h1 class="text-black font-bold text-4xl select-none">TAP TO<br>STROBE</h1>
        </div>

        <div id="app-logs" class="screen hidden w-full h-full flex flex-col p-4">
            <textarea id="log-input" class="w-full h-24 bg-gray-900 border border-wayne p-2 mb-2 rounded" placeholder="Log entry..."></textarea>
            <button onclick="addLog()" class="w-full py-3 bg-wayne/20 border border-wayne mb-4 font-bold">SAVE</button>
            <div id="log-list" class="flex-1 overflow-y-auto space-y-2 border-t border-wayne/30 pt-2"></div>
        </div>
        <div id="app-units" class="screen hidden w-full h-full p-4"><div class="bg-gray-900 p-4 border border-wayne"><input id="unit-m" oninput="this.nextElementSibling.innerText=(this.value*3.28).toFixed(2)+' FT'" class="w-full bg-black p-2 mb-2 text-white border border-wayne" placeholder="Meters"><div class="text-2xl text-center">0 FT</div></div></div>
        <div id="app-chrono" class="screen hidden w-full h-full flex flex-col justify-center items-center"><div id="chrono-d" class="text-6xl font-mono mb-8">00:00</div><button onclick="toggleChrono()" class="py-4 px-8 border border-wayne">START/STOP</button></div>
        <div id="app-rng" class="screen hidden w-full h-full flex flex-col justify-center items-center"><div id="rng-d" class="text-9xl font-bold mb-8">?</div><button onclick="document.getElementById('rng-d').innerText=Math.random()>.5?'HEADS':'TAILS'" class="py-4 px-8 border border-wayne">FLIP</button></div>
        <div id="app-tally" class="screen hidden w-full h-full flex flex-col justify-center items-center"><div id="tally-d" class="text-9xl font-bold mb-8" onclick="this.innerText++">0</div><div class="text-xs">TAP TO COUNT</div></div>

    </main>

    <nav class="h-16 border-t border-wayne/30 bg-black flex justify-center items-center z-40">
        <button onclick="goHome()" class="w-16 h-16 rounded-full border-2 border-wayne bg-black flex items-center justify-center -mt-8 shadow-[0_0_15px_#00f7ff] active:bg-wayne active:text-black transition text-2xl">‚ò∞</button>
    </nav>

    <script>
        // --- UI INIT ---
        document.querySelectorAll('.dash-btn').forEach(btn => {
            if(!btn.className.includes('bg-red')) btn.className = "flex flex-col items-center justify-center p-4 border border-wayne/30 bg-wayne/5 rounded active:bg-wayne active:text-black transition h-24";
            else btn.className = "flex flex-col items-center justify-center p-4 border border-red-500/50 bg-red-900/10 text-red-500 rounded active:bg-red-500 active:text-black transition h-24";
            const span = btn.querySelector('span'); span.className = "text-3xl mb-1";
            btn.innerHTML = span.outerHTML + `<span class="text-[10px] font-bold tracking-widest">${btn.innerText}</span>`;
        });

        // --- CORE ---
        let stream = null;
        let animId = null;
        let activeApp = null;
        setInterval(() => document.getElementById('clock').innerText = new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}), 1000);

        function goHome() {
            stopHardware();
            document.querySelectorAll('.screen').forEach(el => el.classList.add('hidden'));
            document.getElementById('home').classList.remove('hidden');
            activeApp = null;
        }

        function launch(appId) {
            goHome();
            document.getElementById('home').classList.add('hidden');
            document.getElementById('app-' + appId).classList.remove('hidden');
            activeApp = appId;
            if(appId === 'detective') initDetective();
            if(appId === 'nightvis') initNightVis();
            if(appId === 'sonar') initSonar();
            if(appId === 'translator') initTranslatorCam();
            if(appId === 'logs') loadLogs();
        }

        function stopHardware() {
            if(stream) { stream.getTracks().forEach(t => t.stop()); stream = null; }
            if(animId) { cancelAnimationFrame(animId); clearInterval(animId); animId = null; }
            document.getElementById('app-flash').style.backgroundColor = 'white';
        }

        async function getCam() {
            try { return await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } }); } 
            catch(e) { alert("Camera Access Denied"); return null; }
        }

        // --- 1. DETECTIVE (Persistence) ---
        let detModel, detThresh=0.65, persistence={};
        function updateThresh(v) { detThresh = v/100; document.getElementById('det-val').innerText = v+"%"; }
        async function initDetective() {
            const vid=document.getElementById('det-vid'), can=document.getElementById('det-can'), ctx=can.getContext('2d');
            stream = await getCam(); if(!stream) return; vid.srcObject=stream;
            if(!detModel) { document.getElementById('det-load').style.display='flex'; detModel=await cocoSsd.load(); document.getElementById('det-load').style.display='none'; }
            async function loop() {
                if(activeApp!=='detective') return;
                if(vid.readyState===4) {
                    can.width=vid.videoWidth; can.height=vid.videoHeight;
                    const preds = await detModel.detect(vid);
                    ctx.clearRect(0,0,can.width,can.height);
                    for(let k in persistence) persistence[k]--;
                    preds.forEach(p=>{
                        if(p.score<detThresh) return;
                        let id=p.class; if(!persistence[id]) persistence[id]=0; persistence[id]+=2;
                        if(persistence[id]>5) {
                            persistence[id]=Math.min(persistence[id],20);
                            const x=p.bbox[0], y=p.bbox[1], w=p.bbox[2], h=p.bbox[3], l=Math.min(w,h)/4;
                            let c='#00f7ff', txt=p.class.toUpperCase();
                            if(txt==='PERSON') {c='#ff3333'; txt='TARGET';} if(txt==='CELL PHONE') {c='#ffff00'; txt='DEVICE';}
                            ctx.strokeStyle=c; ctx.lineWidth=3; ctx.shadowBlur=10; ctx.shadowColor=c;
                            ctx.beginPath(); ctx.moveTo(x,y+l); ctx.lineTo(x,y); ctx.lineTo(x+l,y); ctx.stroke();
                            ctx.beginPath(); ctx.moveTo(x+w-l,y); ctx.lineTo(x+w,y); ctx.lineTo(x+w,y+l); ctx.stroke();
                            ctx.beginPath(); ctx.moveTo(x,y+h-l); ctx.lineTo(x,y+h); ctx.lineTo(x+l,y+h); ctx.stroke();
                            ctx.beginPath(); ctx.moveTo(x+w-l,y+h); ctx.lineTo(x+w,y+h); ctx.lineTo(x+w,y+h-l); ctx.stroke();
                            ctx.fillStyle=c; ctx.font="bold 14px Courier New"; ctx.fillText(`${txt} ${Math.round(p.score*100)}%`, x+5, y-10);
                        }
                    });
                }
                animId=requestAnimationFrame(loop);
            }
            loop();
        }

        // --- 2. TRANSLATOR ---
        function transTab(t) {
            document.getElementById('trans-tab-text').classList.add('hidden');
            document.getElementById('trans-tab-cam').classList.add('hidden');
            document.getElementById('trans-tab-'+t).classList.remove('hidden');
        }
        function startListening() {
            const SR=window.SpeechRecognition||window.webkitSpeechRecognition; if(!SR) return alert("Speech API Error");
            const r=new SR(); r.lang='en-US'; r.onresult=e=>document.getElementById('trans-input').value=e.results[0][0].transcript; r.start();
        }
        async function runTranslation() {
            const txt = document.getElementById('trans-input').value;
            const lang = document.getElementById('trans-lang').value; // e.g., "es-ES"
            const out = document.getElementById('trans-output');
            
            if(!txt) return;
            out.innerText = "UPLINKING...";
            
            // Extract lang code (es-ES -> es) for API
            const langCode = lang.split('-')[0];
            
            try {
                // Free API
                const res = await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(txt)}&langpair=en|${langCode}`);
                const data = await res.json();
                const trans = data.responseData.translatedText;
                
                out.innerText = trans;
                
                // Speak
                const u = new SpeechSynthesisUtterance(trans);
                u.lang = lang;
                speechSynthesis.speak(u);
            } catch(e) { out.innerText = "LINK FAILED"; }
        }
        async function initTranslatorCam() {
            const vid = document.getElementById('trans-vid');
            stream = await getCam(); if(stream) vid.srcObject=stream;
        }
        async function captureOCR() {
            const vid=document.getElementById('trans-vid');
            const status=document.getElementById('ocr-status');
            const res=document.getElementById('ocr-result');
            
            status.innerText="ANALYZING...";
            const can=document.createElement('canvas'); can.width=vid.videoWidth; can.height=vid.videoHeight;
            const ctx=can.getContext('2d'); ctx.drawImage(vid,0,0);
            
            // Crop center
            const w=can.width*0.6, h=can.height*0.2, x=(can.width-w)/2, y=(can.height-h)/2;
            const crop=document.createElement('canvas'); crop.width=w; crop.height=h;
            const cCtx=crop.getContext('2d');
            
            // Pre-process (B&W)
            cCtx.drawImage(can,x,y,w,h,0,0,w,h);
            const d=cCtx.getImageData(0,0,w,h);
            for(let i=0;i<d.data.length;i+=4) {
                let avg=(d.data[i]+d.data[i+1]+d.data[i+2])/3;
                let c=avg>100?255:0; d.data[i]=d.data[i+1]=d.data[i+2]=c;
            }
            cCtx.putImageData(d,0,0);

            // Tesseract
            const {data:{text}} = await Tesseract.recognize(crop, 'eng');
            const cleanText = text.trim().replace(/\n/g, ' ');
            
            if(cleanText.length > 1) {
                status.innerText="TRANSLATING...";
                // Translate the OCR result
                const lang = document.getElementById('ocr-lang').value;
                const langCode = lang.split('-')[0];
                const r = await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(cleanText)}&langpair=en|${langCode}`);
                const j = await r.json();
                const trans = j.responseData.translatedText;
                
                res.innerText = `${cleanText} -> ${trans}`;
                const u = new SpeechSynthesisUtterance(trans); u.lang=lang; speechSynthesis.speak(u);
                status.innerText="COMPLETE";
            } else { status.innerText="NO TEXT FOUND"; }
        }

        // --- 3. SONAR (Polar) ---
        async function initSonar() {
            try {
                const s = await navigator.mediaDevices.getUserMedia({audio:true}); stream=s;
                const ac=new (window.AudioContext||window.webkitAudioContext)(), src=ac.createMediaStreamSource(s), ana=ac.createAnalyser();
                ana.fftSize=256; src.connect(ana);
                const d=new Uint8Array(ana.frequencyBinCount);
                const ctx=document.getElementById('sonar-can').getContext('2d');
                function draw() {
                    if(activeApp!=='sonar') return;
                    ana.getByteFrequencyData(d);
                    ctx.clearRect(0,0,300,300);
                    const cx=150, cy=150;
                    for(let i=0; i<d.length; i+=2) {
                        if(d[i]>30) {
                            const val = d[i]/255;
                            const angle = (i/d.length) * Math.PI * 2; // Map freq to 360deg
                            const r = val * 140;
                            const x = cx + Math.cos(angle)*r;
                            const y = cy + Math.sin(angle)*r;
                            ctx.beginPath(); ctx.arc(x,y,3*val,0,2*Math.PI);
                            ctx.fillStyle=`rgba(0,247,255,${val})`; ctx.fill();
                        }
                    }
                    animId=requestAnimationFrame(draw);
                }
                draw();
            } catch(e){}
        }

        // --- 4. NIGHT VIS ---
        async function initNightVis() {
            const vid=document.getElementById('nv-vid'), can=document.getElementById('nv-can'), ctx=can.getContext('2d');
            stream = await getCam(); if(!stream) return; vid.srcObject=stream;
            function loop() {
                if(activeApp!=='nightvis') return;
                if(vid.readyState===4) {
                    can.width=vid.videoWidth; can.height=vid.videoHeight;
                    ctx.drawImage(vid,0,0);
                    const f=ctx.getImageData(0,0,can.width,can.height), d=f.data;
                    for(let i=0;i<d.length;i+=4) {
                        let l=0.299*d[i]+0.587*d[i+1]+0.114*d[i+2];
                        l=255*Math.pow(l/255, 0.6); // Gamma
                        d[i]=0; d[i+1]=l; d[i+2]=0;
                    }
                    ctx.putImageData(f,0,0);
                }
                animId=requestAnimationFrame(loop);
            }
            loop();
        }

        // Utils
        function toggleStrobe() {
            const el=document.getElementById('app-flash');
            if(animId) { clearInterval(animId); animId=null; el.style.backgroundColor='white'; }
            else { animId=setInterval(()=>{el.style.backgroundColor=el.style.backgroundColor==='white'?'black':'white'},40); }
        }
        function addLog() { const i=document.getElementById('log-input'), l=document.getElementById('log-list'); if(i.value) l.innerHTML=`<div class="text-xs border-b border-wayne/30 p-2">${new Date().toLocaleTimeString()}: ${i.value}</div>`+l.innerHTML; }
        let cInt, cS=0; function toggleChrono() { if(cInt){clearInterval(cInt);cInt=null;}else{cS=Date.now()-(cS>0?cS:0);cInt=setInterval(()=>{document.getElementById('chrono-d').innerText=new Date(Date.now()-cS).toISOString().substr(14,8)},10);animId=cInt;} }
    </script>
</body>
</html>
