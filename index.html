<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WayneTech OS v7</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#000000">
    <link rel="apple-touch-icon" href="icon.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { wayne: '#00f7ff', alert: '#ff3333', panel: '#0a0a0a' },
                    fontFamily: { mono: ['Courier New', 'monospace'] }
                }
            }
        }
    </script>

    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>
    <script src='https://unpkg.com/tesseract.js@v2.1.0/dist/tesseract.min.js'></script>

    <style>
        body { background-color: black; color: #00f7ff; overflow: hidden; touch-action: none; }
        .scanline {
            width: 100%; height: 100%; position: fixed; left: 0; top: 0; pointer-events: none; z-index: 50;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            background-size: 100% 2px, 3px 100%;
        }
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-thumb { background: #00f7ff; border-radius: 5px; }
    </style>
</head>
<body class="font-mono h-screen w-screen flex flex-col">

    <div class="scanline"></div>

    <header class="h-14 flex items-center justify-between px-4 border-b-2 border-wayne bg-black/90 z-40">
        <div class="text-xl font-bold tracking-widest text-wayne drop-shadow-[0_0_5px_rgba(0,247,255,0.8)]">WAYNETECH</div>
        <div id="clock" class="text-xs text-wayne/70">00:00</div>
    </header>

    <main id="viewport" class="flex-1 relative bg-black overflow-hidden">
        
        <div id="home" class="screen w-full h-full p-4 grid grid-cols-2 gap-4 overflow-y-auto pb-20">
            <button onclick="launch('detective')" class="dash-btn"><span>üëÅÔ∏è</span> DETECTIVE</button>
            <button onclick="launch('vocoder')" class="dash-btn"><span>üó£Ô∏è</span> VOCODER</button>
            <button onclick="launch('nightvis')" class="dash-btn"><span>üåë</span> NIGHT VIS</button>
            <button onclick="launch('sonar')" class="dash-btn"><span>üì°</span> SONAR</button>
            <button onclick="launch('logs')" class="dash-btn"><span>üìù</span> LOGS</button>
            <button onclick="launch('units')" class="dash-btn"><span>üìê</span> UNITS</button>
            <button onclick="launch('chrono')" class="dash-btn"><span>‚è±Ô∏è</span> CHRONO</button>
            <button onclick="launch('rng')" class="dash-btn"><span>üé≤</span> RNG</button>
            <button onclick="launch('tally')" class="dash-btn"><span>üî¢</span> TALLY</button>
            <button onclick="launch('flash')" class="dash-btn text-red-500 border-red-500/50 bg-red-900/10"><span>üí£</span> FLASHBANG</button>
        </div>

        <div id="app-detective" class="screen hidden w-full h-full relative">
            <video id="det-vid" class="absolute inset-0 w-full h-full object-cover" autoplay playsinline muted></video>
            <canvas id="det-can" class="absolute inset-0 w-full h-full object-cover z-10"></canvas>
            <div class="absolute bottom-5 left-0 w-full px-4 z-20">
                <div class="bg-black/80 border border-wayne p-2 rounded">
                    <div class="flex justify-between text-xs mb-1">
                        <span>SENSITIVITY</span> <span id="det-val">60%</span>
                    </div>
                    <input type="range" min="10" max="90" value="60" oninput="updateThresh(this.value)" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer">
                </div>
            </div>
        </div>

        <div id="app-vocoder" class="screen hidden w-full h-full flex flex-col">
            <div class="flex border-b border-wayne">
                <button onclick="vocoderTab('speech')" class="flex-1 p-3 bg-wayne/10 text-xs font-bold active:bg-wayne active:text-black">üé§ SPEECH</button>
                <button onclick="vocoderTab('cam')" class="flex-1 p-3 bg-wayne/10 text-xs font-bold active:bg-wayne active:text-black border-l border-wayne">üì∑ CAM OCR</button>
            </div>

            <div id="voc-tab-speech" class="flex-1 flex flex-col p-4 space-y-4">
                <button onclick="startListening()" class="p-6 border-2 border-wayne rounded-full mx-auto mt-4 active:bg-wayne active:text-black transition"><span class="text-4xl">üéôÔ∏è</span></button>
                <div class="text-center text-xs opacity-70">TAP TO SPEAK</div>
                <textarea id="voc-text" class="w-full h-32 bg-gray-900 border border-wayne p-2 text-sm rounded focus:outline-none" placeholder="Detected text..."></textarea>
                <div class="flex gap-2">
                    <select id="voc-lang" class="bg-gray-900 border border-wayne p-2 text-sm flex-1 rounded">
                        <option value="es-ES">Spanish</option>
                        <option value="fr-FR">French</option>
                        <option value="ja-JP">Japanese</option>
                    </select>
                    <button onclick="speakTranslation()" class="px-4 py-2 bg-wayne/20 border border-wayne rounded font-bold">SPEAK</button>
                </div>
            </div>

            <div id="voc-tab-cam" class="hidden flex-1 relative flex flex-col">
                <div class="relative flex-1 bg-black overflow-hidden">
                    <video id="voc-vid" class="absolute inset-0 w-full h-full object-cover" autoplay playsinline muted></video>
                    <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-64 h-24 border-2 border-wayne shadow-[0_0_20px_#00f7ff] z-10 pointer-events-none"></div>
                    <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 -mt-16 text-xs bg-black px-2">ALIGN TEXT HERE</div>
                </div>
                <div class="h-1/3 bg-gray-900 border-t border-wayne p-4 flex flex-col gap-2">
                    <div id="ocr-status" class="text-xs text-center text-wayne">READY</div>
                    <div class="flex gap-2 h-full">
                        <div id="ocr-preview" class="w-1/3 border border-wayne/50 bg-black"></div> <div class="flex-1 flex flex-col gap-2">
                            <textarea id="ocr-result" class="flex-1 bg-black border border-wayne p-1 text-xs" placeholder="Result..."></textarea>
                            <button onclick="captureOCR()" class="py-2 bg-wayne text-black font-bold text-sm">SCAN & TRANSLATE</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="app-nightvis" class="screen hidden w-full h-full relative">
            <canvas id="nv-canvas" class="w-full h-full object-cover"></canvas>
            <video id="nv-vid" class="hidden" autoplay playsinline muted></video>
            
            <div class="absolute bottom-5 left-0 w-full px-10">
                <div class="text-center text-xs mb-1">DIGITAL GAIN (EXPOSURE)</div>
                <input type="range" min="1" max="5" step="0.5" value="2" id="nv-gain" class="w-full h-2 bg-gray-700 rounded-lg cursor-pointer">
            </div>
        </div>

        <div id="app-sonar" class="screen hidden w-full h-full flex flex-col items-center justify-center bg-black relative">
            <canvas id="sonar-can" class="w-full h-64"></canvas>
            <div class="absolute bottom-10 text-xs text-wayne tracking-widest animate-pulse">AUDIO WAVEFORM ANALYSIS</div>
        </div>

        <div id="app-logs" class="screen hidden w-full h-full flex flex-col p-4">
            <textarea id="log-input" class="w-full h-24 bg-gray-900 border border-wayne p-2 mb-2 rounded" placeholder="Mission entry..."></textarea>
            <button onclick="addLog()" class="w-full py-3 bg-wayne/20 border border-wayne mb-4 font-bold rounded">SAVE LOG</button>
            <div id="log-list" class="flex-1 overflow-y-auto space-y-2 border-t border-wayne/30 pt-2"></div>
        </div>

        <div id="app-units" class="screen hidden w-full h-full flex flex-col p-4 space-y-4">
            <div class="bg-gray-900 p-4 border border-wayne rounded">
                <label class="text-xs">METERS</label>
                <input type="number" id="unit-m" oninput="convertUnits('m')" class="w-full bg-black border border-wayne p-2 text-xl" placeholder="0">
            </div>
            <div class="text-center text-2xl">‚¨áÔ∏è</div>
            <div class="bg-gray-900 p-4 border border-wayne rounded">
                <label class="text-xs">FEET</label>
                <input type="number" id="unit-ft" oninput="convertUnits('ft')" class="w-full bg-black border border-wayne p-2 text-xl" placeholder="0">
            </div>
        </div>

        <div id="app-chrono" class="screen hidden w-full h-full flex flex-col justify-center items-center p-4">
            <div id="chrono-display" class="text-6xl font-bold mb-8 font-mono">00:00.00</div>
            <div class="grid grid-cols-2 gap-4 w-full max-w-xs">
                <button onclick="toggleChrono()" class="py-4 bg-wayne/20 border border-wayne rounded text-xl font-bold">START/STOP</button>
                <button onclick="resetChrono()" class="py-4 bg-red-900/20 border border-red-500 text-red-500 rounded text-xl font-bold">RESET</button>
            </div>
        </div>

        <div id="app-rng" class="screen hidden w-full h-full flex flex-col p-4">
            <div id="rng-display" class="flex-1 flex justify-center items-center text-9xl font-bold text-wayne">?</div>
            <div class="grid grid-cols-2 gap-4 h-24">
                <button onclick="roll(6)" class="bg-wayne/10 border border-wayne rounded font-bold">D6</button>
                <button onclick="roll(20)" class="bg-wayne/10 border border-wayne rounded font-bold">D20</button>
                <button onclick="flipCoin()" class="col-span-2 bg-wayne/10 border border-wayne rounded font-bold">FLIP COIN</button>
            </div>
        </div>

        <div id="app-tally" class="screen hidden w-full h-full flex flex-col p-4">
            <div id="tally-val" class="flex-1 flex justify-center items-center text-9xl font-bold" onclick="updateTally(1)">0</div>
            <div class="grid grid-cols-2 gap-4">
                <button onclick="updateTally(-1)" class="py-4 border border-wayne rounded bg-wayne/10 font-bold">-</button>
                <button onclick="updateTally(0)" class="py-4 border border-alert text-alert rounded bg-alert/10 font-bold">RESET</button>
            </div>
        </div>

        <div id="app-flash" class="screen hidden w-full h-full bg-white z-50 flex justify-center items-center cursor-pointer" onclick="toggleStrobe()">
            <h1 class="text-black font-bold text-4xl select-none">TAP TO<br>STROBE</h1>
        </div>

    </main>

    <nav class="h-16 border-t border-wayne/30 bg-black flex justify-center items-center z-40">
        <button onclick="goHome()" class="px-8 py-2 bg-wayne/10 border border-wayne text-wayne rounded hover:bg-wayne hover:text-black transition font-bold tracking-widest">MENU</button>
    </nav>

    <script>
        // --- TAILWIND COMPONENT STYLES ---
        document.querySelectorAll('.dash-btn').forEach(btn => {
            btn.className = "flex flex-col items-center justify-center p-4 border border-wayne/30 bg-wayne/5 rounded active:bg-wayne active:text-black transition";
            const span = btn.querySelector('span');
            span.className = "text-3xl mb-2";
            btn.innerHTML = span.outerHTML + `<span class="text-xs font-bold">${btn.innerText}</span>`;
        });

        // --- CORE SYSTEM ---
        let stream = null;
        let animationId = null;
        let activeApp = null;
        
        setInterval(() => { document.getElementById('clock').innerText = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}); }, 1000);

        function goHome() {
            stopHardware();
            document.querySelectorAll('.screen').forEach(el => el.classList.add('hidden'));
            document.getElementById('home').classList.remove('hidden');
            activeApp = null;
        }

        function launch(appId) {
            goHome();
            document.getElementById('home').classList.add('hidden');
            document.getElementById('app-' + appId).classList.remove('hidden');
            activeApp = appId;

            if(appId === 'detective') initDetective();
            if(appId === 'nightvis') initNightVis();
            if(appId === 'sonar') initSonar();
            if(appId === 'vocoder') initVocoderCam();
            if(appId === 'logs') loadLogs();
        }

        function stopHardware() {
            if (stream) { stream.getTracks().forEach(track => track.stop()); stream = null; }
            if (animationId) { cancelAnimationFrame(animationId); clearInterval(animationId); animationId = null; }
            document.getElementById('app-flash').style.backgroundColor = 'white';
        }

        async function getCamera() {
            try { return await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } }); } 
            catch(e) { alert("Camera Access Denied"); return null; }
        }

        // --- 1. DETECTIVE ---
        let detModel = null;
        let detThresh = 0.60;
        function updateThresh(v) { detThresh = v/100; document.getElementById('det-val').innerText = v+"%"; }
        
        async function initDetective() {
            const vid = document.getElementById('det-vid');
            const can = document.getElementById('det-can');
            const ctx = can.getContext('2d');
            stream = await getCamera(); if(!stream) return;
            vid.srcObject = stream;
            
            if(!detModel) detModel = await cocoSsd.load();
            
            async function loop() {
                if(activeApp !== 'detective') return;
                if(vid.readyState === 4) {
                    can.width = vid.videoWidth; can.height = vid.videoHeight;
                    const preds = await detModel.detect(vid);
                    ctx.clearRect(0,0,can.width,can.height);
                    preds.forEach(p => {
                        if(p.score < detThresh) return;
                        const color = p.class==='person'?'#ff3333':'#00f7ff';
                        ctx.strokeStyle = color; ctx.lineWidth=4;
                        ctx.strokeRect(p.bbox[0],p.bbox[1],p.bbox[2],p.bbox[3]);
                        ctx.fillStyle=color; ctx.font="bold 18px Courier New";
                        ctx.fillText(p.class.toUpperCase(), p.bbox[0], p.bbox[1]-5);
                    });
                }
                animationId = requestAnimationFrame(loop);
            }
            loop();
        }

        // --- 2. VOCODER (Fixed OCR & Translation) ---
        function vocoderTab(t) {
            document.getElementById('voc-tab-speech').classList.add('hidden');
            document.getElementById('voc-tab-cam').classList.add('hidden');
            document.getElementById('voc-tab-' + t).classList.remove('hidden');
        }
        function startListening() {
            const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
            if(!SR) return alert("No Speech API");
            const r = new SR();
            r.lang = 'en-US';
            r.onresult = e => document.getElementById('voc-text').value = e.results[0][0].transcript;
            r.start();
        }
        async function speakTranslation() {
            const txt = document.getElementById('voc-text').value;
            const lang = document.getElementById('voc-lang').value;
            if(!txt) return;
            const u = new SpeechSynthesisUtterance(txt);
            u.lang = lang;
            speechSynthesis.speak(u);
        }

        // CAM OCR LOGIC
        async function initVocoderCam() {
            const vid = document.getElementById('voc-vid');
            stream = await getCamera(); if(!stream) return;
            vid.srcObject = stream;
        }

        async function captureOCR() {
            const vid = document.getElementById('voc-vid');
            const status = document.getElementById('ocr-status');
            const res = document.getElementById('ocr-result');
            const prev = document.getElementById('ocr-preview');
            
            status.innerText = "PROCESSING IMAGE...";
            
            // 1. Capture & Crop
            const can = document.createElement('canvas');
            can.width = vid.videoWidth; can.height = vid.videoHeight;
            const ctx = can.getContext('2d');
            ctx.drawImage(vid, 0, 0);

            // Calculate center crop (matches the CSS box)
            const w = can.width * 0.6;
            const h = can.height * 0.2; 
            const x = (can.width - w) / 2;
            const y = (can.height - h) / 2;

            const cropCan = document.createElement('canvas');
            cropCan.width = w; cropCan.height = h;
            const cCtx = cropCan.getContext('2d');
            
            // 2. PRE-PROCESS (Grayscale + High Contrast)
            cCtx.drawImage(can, x, y, w, h, 0, 0, w, h);
            const imgData = cCtx.getImageData(0, 0, w, h);
            const d = imgData.data;
            for (let i = 0; i < d.length; i += 4) {
                let avg = (d[i] + d[i+1] + d[i+2]) / 3;
                let c = avg > 100 ? 255 : 0; 
                d[i] = d[i+1] = d[i+2] = c;
            }
            cCtx.putImageData(imgData, 0, 0);

            prev.innerHTML = '';
            cropCan.style.width = '100%';
            prev.appendChild(cropCan);

            // 3. Tesseract
            const { data: { text } } = await Tesseract.recognize(cropCan, 'eng');
            
            if(text.trim().length > 0) {
                res.value = text.trim();
                status.innerText = "TEXT FOUND";
                const u = new SpeechSynthesisUtterance(text);
                speechSynthesis.speak(u);
            } else {
                status.innerText = "NO TEXT DETECTED";
            }
        }

        // --- 3. NIGHT VIS (Gamma Correction) ---
        async function initNightVis() {
            const vid = document.getElementById('nv-vid');
            const can = document.getElementById('nv-canvas');
            const ctx = can.getContext('2d');
            stream = await getCamera(); if(!stream) return;
            vid.srcObject = stream;

            function process() {
                if(activeApp !== 'nightvis') return;
                if(vid.readyState === 4) {
                    can.width = vid.videoWidth; can.height = vid.videoHeight;
                    ctx.drawImage(vid, 0, 0);
                    
                    const frame = ctx.getImageData(0,0,can.width,can.height);
                    const d = frame.data;
                    const gain = document.getElementById('nv-gain').value;
                    
                    for(let i=0; i<d.length; i+=4) {
                        const r = d[i], g = d[i+1], b = d[i+2];
                        const v = (0.2126*r + 0.7152*g + 0.0722*b) * gain;
                        d[i] = 0;  
                        d[i+1] = v; 
                        d[i+2] = 0; 
                    }
                    ctx.putImageData(frame, 0, 0);
                }
                animationId = requestAnimationFrame(process);
            }
            process();
        }

        // --- 4. SONAR (Mirrored) ---
        async function initSonar() {
            try {
                const s = await navigator.mediaDevices.getUserMedia({audio:true});
                stream = s;
                const ac = new (window.AudioContext||window.webkitAudioContext)();
                const src = ac.createMediaStreamSource(s);
                const ana = ac.createAnalyser();
                ana.fftSize = 256; src.connect(ana);
                const data = new Uint8Array(ana.frequencyBinCount);
                const can = document.getElementById('sonar-can');
                const ctx = can.getContext('2d');

                function draw() {
                    if(activeApp !== 'sonar') return;
                    can.width = can.clientWidth; can.height = can.clientHeight;
                    ana.getByteFrequencyData(data);
                    
                    ctx.fillStyle = "#000"; ctx.fillRect(0,0,can.width,can.height);
                    
                    const cx = can.width / 2;
                    const cy = can.height / 2;
                    
                    for(let i=0; i<data.length; i++) {
                        const h = (data[i]/255) * (can.height/2);
                        const w = (can.width/2) / data.length;
                        const x = i * w;
                        
                        ctx.fillStyle = `rgba(0, 247, 255, ${data[i]/200})`;
                        
                        ctx.fillRect(cx + x, cy - h/2, w-1, h);
                        ctx.fillRect(cx - x - w, cy - h/2, w-1, h);
                    }
                    animationId = requestAnimationFrame(draw);
                }
                draw();
            } catch(e) { alert("Mic Denied"); }
        }

        // --- UTILS ---
        function addLog() {
            const i = document.getElementById('log-input');
            if(!i.value) return;
            const l = document.getElementById('log-list');
            l.innerHTML = `<div class="p-2 border-b border-wayne/30 text-xs text-wayne">${new Date().toLocaleTimeString()}: ${i.value}</div>` + l.innerHTML;
            i.value = "";
        }
        function convertUnits(t) {
            const m = document.getElementById('unit-m');
            const ft = document.getElementById('unit-ft');
            if(t==='m') ft.value = (m.value*3.28).toFixed(2);
            else m.value = (ft.value/3.28).toFixed(2);
        }
        let cInt; let cSt=0;
        function toggleChrono() {
            if(cInt) { clearInterval(cInt); cInt=null; }
            else {
                cSt = Date.now() - (cSt>0?cSt:0);
                cInt = setInterval(()=>{ document.getElementById('chrono-display').innerText = new Date(Date.now()-cSt).toISOString().substr(14,8); },10);
                animationId = cInt;
            }
        }
        function resetChrono() { clearInterval(cInt); cInt=null; cSt=0; document.getElementById('chrono-display').innerText="00:00.00"; }
        function roll(m) { document.getElementById('rng-display').innerText = Math.floor(Math.random()*m)+1; }
        function flipCoin() { document.getElementById('rng-display').innerText = Math.random()>.5?"HEADS":"TAILS"; }
        function updateTally(n) { 
            const el=document.getElementById('tally-val'); 
            el.innerText = n===0 ? 0 : parseInt(el.innerText)+n; 
        }
        function toggleStrobe() {
            const el = document.getElementById('app-flash');
            if(animationId) { clearInterval(animationId); animationId=null; el.style.backgroundColor='white'; }
            else { animationId = setInterval(()=>{ el.style.backgroundColor=el.style.backgroundColor==='white'?'black':'white'; }, 50); }
        }
    </script>
</body>
</html>
